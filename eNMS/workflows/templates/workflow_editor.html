{% extends "base_site.html" %}

{% block title %} User management {% endblock title %}

{% block stylesheets %}
  {{ super() }}
 <!-- Vis CSS -->
  <link href="{{ url_for('workflows_blueprint.static', filename='vis/vis-network.min.css') }}" rel="stylesheet">
{% endblock stylesheets %}

{% block content %}
  {% include 'inner_task_scheduling_modal.html' %}
  {% include 'editor_panels.html' %}
{% endblock content %}

{% block javascripts %}
  {{ super()}}
  <script>
    var workflow = {{ workflow|tojson|safe }};
  </script>
  <!-- Task scheduling -->
  <script src="{{ url_for('tasks_blueprint.static', filename='scheduleTask.js') }}"></script>
  <!-- Vis JS -->
  <script src="{{ url_for('workflows_blueprint.static', filename='vis/vis.js') }}"></script>
  <script>
    function scheduleTask() {
      if (workflow && $("#scheduling-form").parsley().validate()) {
        $.ajax({
          type: "POST",
          url: `/tasks/scheduler/inner_task/${workflow.id}`,
          dataType: "json",
          data: $("#scheduling-form").serialize(),
          success: function(task) {
            nodes.add({
              id: task.id,
              label: task.name,
              type: task.type
            });
            $.ajax({
              type: "POST",
              url: `/workflows/add_node/${workflow.id}/${task.id}`,
              success: function(script){
                alertify.notify("Task created", 'success', 5);
              }
            });
            $("#scheduling").modal('hide');
          }
        });
      } else {
        alertify.notify('Some fields are missing', 'error', 5);
      }
    }

    if (workflow) {
      $("#workflow").text = workflow.name
    } else {
      $.ajax({
        type: "POST",
        url: `/workflows/get/${$("#workflow-name").val()}`,
        success: function(wf) {
          workflow = wf;
        }
      });
    }

    function showModal(modal_name){
      $(`#${modal_name}`).modal('show');
      }

    var container = document.getElementById('network');
    var dsoptions = {
      edges: {
        font: {
          size: 12
        }
      },
      nodes: {
        shape: 'box',
        font: {
          bold: {
            color: '#0077aa'
          }
        }
      },
      manipulation: {
        enabled: false,
        addNode: function (data, callback) {
          // filling in the popup DOM elements
          console.log(data);
        },
        editNode: function (data, callback) {
          // filling in the popup DOM elements
          console.log('edit', data);
        },
        addEdge: function (data, callback) {
          data.arrows = {to: {enabled: true}};
          data.type = edge_type;
          data.label = edge_type;
          color = edge_type == 'success' ? 'green' : 'red'
          data.color = { color: color }
          if (data.from != data.to) {
            edges.add(data);
          }
          network.addEdgeMode();
          saveWorkflow()
        }
      }
    };

    // Create a DataSet with data (enables two way data binding)
    var nodes = new vis.DataSet([]);
        edges = new vis.DataSet([]);
        data = {nodes: nodes, edges: edges};
        network = new vis.Network(container, data, dsoptions);

    // when a filter is selected, apply it
    $('#workflow').on('change', function() {
      $.ajax({
        type: "POST",
        url: `/workflows/get/${this.value}`,
        dataType: "json",
        success: function(workflow){
          var nodes = new vis.DataSet([]);
          for (var i = 0; i < workflow.tasks; i++) {
            var task = workflow[i];
            nodes.push({
              id: task.id,
              label: task.name,
            })
          }
          var data = {nodes: new vis.DataSet(nodes)};
          network.setData(data);
        alertify.notify(`Workflow '${workflow.name}' displayed`, 'success', 5);
        }
      });
    });

    network.on( 'doubleClick', function(properties) {
        var ids = properties.nodes;
        var node = nodes.get(ids)[0];
        if(typeof node !== "undefined") {
          showObjectModal(node.type, node.label);
        }
    });

    // use force-based algorithm upon loading the graph, stop after it has stabilized
    network.on("stabilizationIterationsDone", function () {
        network.setOptions( { physics: false } );
    });

    function addNode(task) {
      if (workflow) {
        nodes.add({
          id: task.id,
          label: task.name,
          type: task.type
        });
        $.ajax({
          type: "POST",
          url: `/workflows/save_node/${workflow.id}/${task.id}`,
          success: function(script){
            alertify.notify("Scripts successfully added to the workflow", 'success', 5);
          }
        });
      } else {
        alertify.notify("You must create a workflow first", 'error', 5);
      }
    }

    function deleteSelection() {
      console.log(getSelection());
      network.deleteSelected();
      saveWorkflow()
      alertify.notify("Selected objects deleted", 'success', 5);
    }

    function switchMode(mode) {
      if (mode == "success" || mode == "failure") {
        edge_type = mode;
        network.addEdgeMode();
        alertify.notify(`Mode: creation of ${mode} edge`, 'success', 5);
      } else {
        network.addNodeMode();
        alertify.notify("Mode: node motion", 'success', 5);
      }
    }

    function saveWorkflow() {
      ajax_data = {
        'nodes':  nodes.get({fields: ['id', 'label']}),
        'edges': edges.get({fields: ['to', 'from', 'type']}),
        'start': start
      }
      $.ajax({
        type: "POST",
        url: `/workflows/add_node/${workflow.id}`,
        contentType: 'application/json;charset=UTF-8',
        data: JSON.stringify(ajax_data, null, '\t'),
        success: function(msg){
          alertify.notify("Workflow saved", 'success', 5);
        }
      });
    }

    function runWorkflow() {
      $.ajax({
        type: "POST",
        url: `/workflows/run_${workflow.id}`,
        contentType: 'application/json;charset=UTF-8',
        success: function(){
          alertify.notify("Workflow successfully started", 'success', 5);
        }
      });
    }
    var types = [{% for type in type_to_form %} "{{ type }}", {% endfor %}];
    for (i = 0; i < types.length; i++) {
      $(`#${types[i]}-button`).text("Update");
    }

    function showObjectModal(type, id) {
      $('#title').text(`Edit properties`);
      $.ajax({
        type: "POST",
        url: `/scripts/get/${type}/${id}`,
        success: function(properties){
          for (const [property, value] of Object.entries(properties)) {
            $(`#${type}-${property}`).val(value);
          }
        }
      });
      $(`#edit-${type}`).modal('show');
    }

  </script>
{% endblock javascripts %}
